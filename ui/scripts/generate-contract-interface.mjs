import fs from 'node:fs';
import path from 'node:path';
import { execSync } from 'node:child_process';

const repoRoot = path.resolve(process.cwd(), '..');
const abiPath = path.join(process.cwd(), 'src', 'abis', 'agiJobManager.ts');
const raw = fs.readFileSync(abiPath, 'utf8');

const itemRegex = /\{"type":"(function|event|error)","name":"([^"]+)"/g;
const buckets = { function: new Set(), event: new Set(), error: new Set() };
for (const match of raw.matchAll(itemRegex)) {
  buckets[match[1]].add(match[2]);
}

const toSection = (title, values) => {
  const list = [...values].sort((a, b) => a.localeCompare(b));
  return `## ${title}\n\n${list.map((v) => `- \`${v}\``).join('\n')}\n`;
};

const getGeneratedStamp = () => {
  if (process.env.SOURCE_DATE_EPOCH) {
    const epoch = Number(process.env.SOURCE_DATE_EPOCH);
    if (Number.isFinite(epoch) && epoch > 0) {
      return new Date(epoch * 1000).toISOString();
    }
  }

  try {
    return execSync('git log -1 --format=%cI', { cwd: repoRoot, encoding: 'utf8' }).trim();
  } catch {
    return new Date().toISOString();
  }
};

const stamp = getGeneratedStamp();
const markdown = `# AGIJobManager UI Contract Interface\n\nGenerated by \`ui/scripts/generate-contract-interface.mjs\` from \`ui/src/abis/agiJobManager.ts\`.\n\n- Generated at: ${stamp}\n\n${toSection('Functions used by UI', buckets.function)}\n${toSection('Events used by UI', buckets.event)}\n${toSection('Custom errors decoded by UI', buckets.error)}\n## UI compatibility contract\n\nThe UI assumes the listed selectors remain available and semantically stable. If a deployment removes or renames any function/event/error above, regenerate this document and update all read paths, simulation-first write flows, and error remediation mappings before release.\n`;

const output = path.join(repoRoot, 'docs', 'ui', 'CONTRACT_INTERFACE.md');
fs.writeFileSync(output, markdown);
console.log(`Wrote ${path.relative(repoRoot, output)}`);
