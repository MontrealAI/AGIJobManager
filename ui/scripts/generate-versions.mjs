import fs from 'node:fs';
import path from 'node:path';
import { execSync } from 'node:child_process';

const repoRoot = path.resolve(process.cwd(), '..');
const pkg = JSON.parse(fs.readFileSync(path.join(process.cwd(), 'package.json'), 'utf8'));
const keys = ['next', 'react', 'react-dom', 'tailwindcss', 'wagmi', 'viem', '@rainbow-me/rainbowkit', '@tanstack/react-query', 'zod', 'vitest', 'fast-check', '@playwright/test'];
const all = { ...pkg.dependencies, ...pkg.devDependencies };

const getSafeISOStringFromEpoch = (sourceDateEpoch) => {
  const epoch = Number(sourceDateEpoch);
  if (!Number.isFinite(epoch) || epoch < 0) return null;

  const epochMs = epoch * 1000;
  if (!Number.isFinite(epochMs)) return null;

  const date = new Date(epochMs);
  if (Number.isNaN(date.getTime())) return null;

  return date.toISOString();
};

const getGeneratedStamp = () => {
  if (process.env.SOURCE_DATE_EPOCH) {
    const stampFromEpoch = getSafeISOStringFromEpoch(process.env.SOURCE_DATE_EPOCH);
    if (stampFromEpoch) return stampFromEpoch;
  }

  try {
    return execSync('git log -1 --format=%cI', { cwd: repoRoot, encoding: 'utf8' }).trim();
  } catch {
    return new Date().toISOString();
  }
};

const stamp = getGeneratedStamp();
const rows = keys.map((k) => `| ${k} | ${all[k] ?? 'n/a'} |`).join('\n');
const markdown = `# UI Versions\n\nGenerated by \`ui/scripts/generate-versions.mjs\`.\n\n- Generated at: ${stamp}\n- Node engine: ${pkg.engines?.node ?? 'unspecified'}\n\n| Package | Pinned Version |\n|---|---|\n${rows}\n`;

const output = path.join(repoRoot, 'docs', 'ui', 'VERSIONS.md');
fs.writeFileSync(output, markdown);
console.log(`Wrote ${path.relative(repoRoot, output)}`);
