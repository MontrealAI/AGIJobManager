import fs from 'node:fs';
import path from 'node:path';

const repoRoot = path.resolve(process.cwd(), '..');
const pkgPath = path.join(process.cwd(), 'package.json');
const lockPath = path.join(process.cwd(), 'package-lock.json');
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
const lock = JSON.parse(fs.readFileSync(lockPath, 'utf8'));
const out = path.join(repoRoot, 'docs/ui/VERSIONS.md');

const keyDeps = [
  'next',
  'react',
  'wagmi',
  'viem',
  '@rainbow-me/rainbowkit',
  '@tanstack/react-query',
  'tailwindcss',
  'vitest',
  'fast-check',
  '@playwright/test',
  '@axe-core/playwright'
];

const getVersion = (name) => pkg.dependencies?.[name] ?? pkg.devDependencies?.[name] ?? 'n/a';
const lockGeneratedAt = new Date(fs.statSync(lockPath).mtimeMs).toISOString();

const body = `# UI Versions\n\nGenerated by \`ui/scripts/generate-versions.mjs\`.\n\n- Node engine: \`${pkg.engines?.node ?? 'unspecified'}\`\n- npm lockfile version: \`${lock.lockfileVersion ?? 'unknown'}\`\n- Lockfile timestamp (UTC): \`${lockGeneratedAt}\`\n\n| Package | Pinned version |\n|---|---|\n${keyDeps.map((name) => `| ${name} | ${getVersion(name)} |`).join('\n')}\n`;

fs.writeFileSync(out, body);
console.log(`Wrote ${out}`);
