# ERC‑8004 integration (signaling → enforcement)

AGIJobManager keeps escrow and settlement logic fully on‑chain and avoids external dependencies in critical flows. ERC‑8004 integration is intentionally **off‑chain** in this repository.

## Source of truth
ERC‑8004 evolves. Always confirm the latest contracts, ABIs, examples, and deployment addresses at:
- https://8004.org/ (overview)
- https://8004.org/build (builder guide)
- https://eips.ethereum.org/EIPS/eip-8004 (spec)

## Why AGIJobManager is not hardwired to ERC‑8004
Coupling escrow settlement to an external registry would introduce **liveness and dependency risks** (e.g., if a registry or indexer is unavailable). AGIJobManager therefore remains a self-contained enforcement layer, while ERC‑8004 operates as a signaling layer.

### What is implemented here vs. off‑chain
- **Implemented in this repo**: escrow/settlement, validator gating, dispute resolution, and reputation updates inside `AGIJobManager`.
- **Off‑chain only**: publishing, indexing, and ranking ERC‑8004 trust signals.

## What ERC‑8004 provides
- **Identity registry** (agent NFTs): `agentURI` points to a registration file.
- **Registration file**: includes `services`, optional `x402Support`, `active`, and `registrations` entries for multi-registry discovery.
- **Reputation signals**: compact feedback entries (`tag1`, `tag2`, `value`, `valueDecimals`) with optional proof-of-payment anchors.
- **Reserved `agentWallet` metadata**: registries may use `setAgentWallet` / `unsetAgentWallet` to bind payout wallets (see 8004.org/build for current ABI).

## Registration file schema (required fields)
The registration file **MUST** use:
```json
{"type":"https://eips.ethereum.org/EIPS/eip-8004#registration-v1"}
```
Required fields and conventions:
- `name`, `description`, `image`
- `services[]` (each entry has at least `name` + `endpoint`)
- `x402Support` (boolean)
- `active` (boolean)
- `registrations[]` with entries `{ agentId, agentRegistry }`
- `agentRegistry` format: `{namespace}:{chainId}:{identityRegistry}` (e.g., `eip155:1:0x...`)
- `supportedTrust` is optional; if absent/empty, treat the registration as **discovery-only** (no trust claim)

### Endpoint-domain verification
For endpoint-domain verification, host:
```
https://{endpoint-domain}/.well-known/agent-registration.json
```
Clients should verify that the `registrations[]` entries match the same `agentRegistry` + `agentId` advertised by the agent.

## Reputation signal encoding
ERC‑8004 uses fixed-point encoding:
- `value` + `valueDecimals` (supports decimals, negatives, and values > 100)
- `tag1` and `tag2` provide semantics

Encoding examples:
- successRate **99.80%** → `value=9980`, `valueDecimals=2`
- downvote **−1** → `value=-1`, `valueDecimals=0`
- revenues **556000** → `value=556000`, `valueDecimals=0`

### Recommended `tag1` set for AGIJobManager
| tag1 | Derivation | Notes |
| --- | --- | --- |
| `successRate` | From `JobCompleted` / `JobApplied` | Derived from on-chain events. |
| `disputeRate` | From `JobDisputed` / `JobApplied` | Derived from on-chain events. |
| `responseTime` | From assignment → completion request/complete | Proxy from block timestamps. |
| `blocktimeFreshness` | From latest activity block | Proxy for recency. |
| `revenues` | Sum of payouts for completed jobs | Proxy (raw token units). |
| `ownerVerified` | External observation | Requires off-chain verification. |
| `reachable` | External observation | Requires monitoring. |
| `uptime` | External observation | Requires monitoring. |

`tag2` should be `observer` for adapter-generated metrics. External raters may use `user`/`watcher`/`ranker` per the spec.

## Trusted client set guidance
A conservative, sybil-resistant set for AGIJobManager reputation is:
- **Addresses that created paid jobs** (`JobCreated` with payout > 0)

This anchors trust signals to economic participation and limits rater spam.

## Off‑chain adapter
See the adapter README and spec for the mapping rules and export steps:
- `integrations/erc8004/README.md`
- `integrations/erc8004/adapter_spec.md`

## Flow diagram
See `docs/diagrams/erc8004_agijobmanager_flow.md` for a high-level flow diagram.
