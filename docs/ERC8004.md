# AGIJobManager ↔ ERC‑8004 (off‑chain integration)

AGIJobManager stays **self‑contained on‑chain** for escrow, validation, dispute resolution, and payouts. ERC‑8004 provides a **separate, off‑chain signaling layer** (Identity Registry + Reputation Registry). This repo integrates the two **without modifying on‑chain AGIJobManager logic** by exporting ERC‑8004‑compatible artifacts from AGIJobManager events.

## From signaling → enforcement (recommended pattern)
**What ERC‑8004 provides**: a standardized off‑chain format for identity, reputation, and validation signals that can be indexed and ranked.
**What AGIJobManager provides**: on‑chain settlement enforcement (escrow, payouts, disputes, reputation mapping) and role gating via ENS/Merkle allowlists.

**Recommended integration pattern (no contract changes required)**
1. Publish ERC‑8004 trust signals for agents, validators, and outcomes.
2. Index/rank those signals off‑chain and apply your policy (allowlists, tiers, exclusions).
3. Update AGIJobManager allowlists/Merkle roots at deployment (or use explicit allowlists post‑deploy) based on that policy.
4. Use AGIJobManager as the settlement anchor; do not rely on ERC‑8004 contracts for escrow liveness.

**Implemented here**: validator‑gated escrow, dispute resolution, reputation updates, ENS/Merkle role gating, and job NFT issuance.
**Not implemented here**: any on‑chain ERC‑8004 registry or trust‑signal processing.

## What ERC‑8004 is (one‑page summary)
**Identity Registry**
- ERC‑721 registry where each agent is an NFT (`agentId`).
- The NFT’s `agentURI` points to an **agent registration file** (registration‑v1 JSON).
- Optional `agentWallet` metadata allows a canonical receiving wallet to be verified on‑chain via `setAgentWallet`/`unsetAgentWallet`.

**Reputation Registry**
- Standardized feedback entries with a **fixed‑point signal**: `value` (`int128`) + `valueDecimals` (`uint8`, 0–18).
- Optional metadata fields: `tag1`, `tag2`, `endpoint`, and optional off‑chain `feedbackURI` + `feedbackHash`.
- Designed for both on‑chain composability and off‑chain aggregation.

## Why AGIJobManager stays self‑contained
AGIJobManager does **not** call external ERC‑8004 contracts in critical paths (escrow, dispute resolution, payouts). This prevents **liveness/griefing risk** (e.g., stalled settlements if external registries are down) and keeps the enforcement plane deterministic.

## Registration (registration‑v1, exact schema)
The **registration JSON** must match the ERC‑8004 `registration-v1` schema exactly:

```jsonc
{
  "type": "https://eips.ethereum.org/EIPS/eip-8004#registration-v1",
  "name": "myAgentName",
  "description": "A natural language description of the Agent",
  "image": "https://example.com/agentimage.png",
  "services": [
    { "name": "web", "endpoint": "https://web.agentxyz.com/" },
    { "name": "A2A", "endpoint": "https://agent.example/.well-known/agent-card.json", "version": "0.3.0" },
    { "name": "MCP", "endpoint": "https://mcp.agent.eth/", "version": "2025-06-18" }
  ],
  "x402Support": false,
  "active": true,
  "registrations": [
    {
      "agentId": 22,
      "agentRegistry": "{namespace}:{chainId}:{identityRegistry}"
    }
  ]
}
```

**Required fields**: `type`, `name`, `description`, `image`, `services[]`, `x402Support`, `active`, `registrations[]`.
`registrations[]` must include `{ agentId, agentRegistry }`, where `agentRegistry` is `{namespace}:{chainId}:{identityRegistry}`.
`services` is the canonical field name (not `endpoints`).

### Endpoint‑domain verification (optional)
If a service uses an HTTPS domain, the agent MAY optionally prove control by hosting:
```
https://{endpoint-domain}/.well-known/agent-registration.json
```
The file must contain at least a `registrations[]` list with a matching `{ agentRegistry, agentId }`. See `integrations/erc8004/examples/.well-known/agent-registration.json`.

### Hosting + agentURI
Host the registration JSON on **HTTPS** or **IPFS** and set the Identity Registry `agentURI` to that location. The `agentURI` can be updated via `setAgentURI(...)`.

## Reputation signals (EIP conventions)
ERC‑8004 encodes signals as `value` + `valueDecimals` (supports negatives and decimals). Examples:
- **successRate 99.80%** → `value=9980`, `valueDecimals=2`
- **downvote −1** → `value=-1`, `valueDecimals=0`
- **revenues 556000** → `value=556000`, `valueDecimals=0`

`tag1` and `tag2` are free‑form selectors used for filtering/aggregation. We use conservative, event‑derivable tags in this repo (see `integrations/erc8004/adapter_spec.md`).

**Optional enrichment**: feedback can reference off‑chain context via `feedbackURI` + `feedbackHash`, and payments can be attached via the optional `proofOfPayment` object in the off‑chain feedback JSON (see the EIP “Off‑Chain Feedback File Structure” section).

### Off‑chain feedback file (required fields)
The optional off‑chain feedback file must include:
- `agentRegistry` (`{namespace}:{chainId}:{identityRegistry}`)
- `agentId`
- `clientAddress` (CAIP style, e.g., `eip155:1:0x...`)
- `createdAt` (ISO‑8601)
- `value`, `valueDecimals`

Optional fields: `tag1`, `tag2`, `endpoint`, `comment`, `proofOfPayment` (and any additional fields permitted by the spec).

## Trusted client set guidance (sybil resistance)
For AGIJobManager feedback, a strong default policy for “trusted clients” is:
- **Addresses that created paid jobs** (derived from `JobCreated` with `payout > 0`).

**Trade‑off**: this improves sybil resistance but reduces coverage (agents with few paid jobs get fewer ratings). Indexers/rankers should document their policy.

## Critical EIP constraint (must document)
**The feedback submitter MUST NOT be the agent owner or an approved operator** for that `agentId`. As a result, **on‑chain feedback is normally submitted by employers, validators, or third‑party observers**, not by the agent itself.

## Off‑chain adapter flow
```mermaid
flowchart LR
    A[AGIJobManager events] --> B[Off-chain adapter]
    B --> C[ERC-8004 feedback files]
    C --> D[Optional submitFeedback (giveFeedback) transactions]
```

- The adapter is in `scripts/erc8004/export_feedback.js`.
- The mapping rules are in `integrations/erc8004/adapter_spec.md`.

## Quick links
- Adapter quickstart: `integrations/erc8004/README.md`
- Examples: `integrations/erc8004/examples/`
