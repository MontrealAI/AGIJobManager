# ERC‑8004 integration (signaling → enforcement)

AGIJobManager keeps escrow and settlement logic fully on‑chain and avoids external dependencies in critical flows. ERC‑8004 integration is intentionally **off‑chain** in this repository. For the detailed mapping spec and threat model, see [`docs/erc8004/README.md`](erc8004/README.md).

## What is ERC‑8004?
ERC‑8004 standardizes how agent identity, reputation, and validation signals are published so other systems can index and consume them consistently.

**Source of truth** (always check for the latest addresses/ABIs before submitting on‑chain feedback):
- https://www.8004.org/
- https://www.8004.org/build
- https://eips.ethereum.org/EIPS/eip-8004
- https://ai.ethereum.foundation/blog/intro-erc-8004

## Why AGIJobManager is not hardwired to ERC‑8004
Coupling escrow settlement to an external registry would introduce **liveness and dependency risks** (e.g., if a registry or indexer is unavailable). AGIJobManager therefore remains a self-contained enforcement layer, while ERC‑8004 operates as a signaling layer.

### What is implemented here vs. off‑chain
- **Implemented in this repo**: escrow/settlement, validator gating, dispute resolution, and reputation updates inside `AGIJobManager`.
- **Off‑chain only**: publishing, indexing, and ranking ERC‑8004 trust signals.

## Recommended integration pattern (no contract changes required)
1. **Publish trust signals** via ERC‑8004 (identity, reputation, validation outcomes).
2. **Index and rank** those signals off‑chain.
3. **Translate policy into allowlists** (Merkle roots at deployment, explicit allowlists/blacklists during operation).
4. **Use AGIJobManager** as the on‑chain escrow and settlement anchor.

## How to combine ERC‑8004 and AGIJobManager in practice
A practical workflow without contract changes:
- Publish ERC‑8004 identity and reputation updates for agents and validators.
- Run an indexer/ranker that produces a trusted set based on those signals.
- Encode the trusted set into the Merkle roots used at deployment, or add addresses to `additionalAgents` / `additionalValidators`.
- Use AGIJobManager to enforce payouts, refunds, and reputation updates.

## Registration file schema (registration‑v1)
The ERC‑8004 registration file **must** declare the following:
- `type`: **exactly** `"https://eips.ethereum.org/EIPS/eip-8004#registration-v1"`
- Required fields: `name`, `description`, `image`, `services[]`, `x402Support`, `active`, `registrations[]`
- `registrations[]` **must** include `{ agentId, agentRegistry }`
  - `agentRegistry` is a CAIP‑style string: `{namespace}:{chainId}:{identityRegistry}` (e.g., `eip155:1:0x742...`)
- `supportedTrust` is **optional** (omit or leave empty for discovery‑only)

**Endpoint‑domain verification** (optional but recommended):
- Host `https://{endpoint-domain}/.well-known/agent-registration.json`
- File should contain a `registrations[]` entry that matches the on‑chain `agentRegistry + agentId`.

Example registration JSON lives here:

- `integrations/erc8004/examples/registration.json`
- `integrations/erc8004/examples/.well-known/agent-registration.json`

Host the registration JSON via HTTPS or IPFS and reference it from the ERC‑8004 identity token’s metadata (exact field depends on the registry implementation you use).

### Reserved `agentWallet` semantics
ERC‑8004 reserves on‑chain metadata for a canonical agent wallet address. Use the registry’s `setAgentWallet`/`unsetAgentWallet` semantics (per the latest build docs) rather than overloading custom metadata fields.

## Mapping AGIJobManager events to ERC‑8004 signals
AGIJobManager emits job lifecycle events that can be mapped to reputation metrics. The adapter in `integrations/erc8004/` aggregates these into per‑agent metrics, then encodes them as ERC‑8004 signals with `value` and `valueDecimals` (supporting decimals and negative values).

Recommended `tag1` examples for AGIJobManager:
- `successRate`
- `disputeRate`
- `responseTime`
- `blocktimeFreshness`
- `revenues`
- `ownerVerified`
- `reachable`
- `uptime`

Encoding examples:
- successRate 99.80% → `value=9980`, `valueDecimals=2`
- downvote −1 → `value=-1`, `valueDecimals=0`
- revenues $556,000 → `value=556000`, `valueDecimals=0`

`tag2` guidance (per ERC‑8004 conventions):
- Use `tag2` for **who or what** qualified the signal (e.g., `user`, `watcher`, `ranker`) or for **units** like `blocks` when needed.
- Leave `tag2` empty when it adds no precision.

## Trusted client set guidance
For AGIJobManager feedback, a strong eligibility set for “trusted clients” is: addresses that actually created paid jobs (derived from `JobCreated` events). This reduces sybil feedback and mirrors real economic participation.

## Off‑chain adapter
See the adapter README and spec for how events map into metrics and how to export JSON artifacts:

- `integrations/erc8004/README.md`
- `integrations/erc8004/adapter_spec.md`
