# AGIJobManager Interface Reference (ABI‑accurate)

This reference is derived from the compiled ABI (`build/contracts/AGIJobManager.json`). It documents every public/external function, event, error, and public state variable.

## Enums

- `JobStatus` (numeric ordering is stable):
  - `0 Deleted`, `1 Open`, `2 InProgress`, `3 CompletionRequested`, `4 Disputed`, `5 Completed`, `6 Expired`.
- `DisputeResolutionCode` (numeric ordering is stable):
  - `0 NO_ACTION`, `1 AGENT_WIN`, `2 EMPLOYER_WIN`.

## Custom errors (all zero‑argument)

Custom errors are used instead of revert strings for gas efficiency. Integrators should decode the error selector and map to these meanings:

- `NotModerator`: caller is not in `moderators`.
- `NotAuthorized`: caller fails role/ownership checks.
- `Blacklisted`: caller is blacklisted (agent or validator).
- `InvalidParameters`: invalid input values or invalid URI.
- `InvalidState`: job/listing state does not allow the action.
- `JobNotFound`: jobId does not exist or has been deleted.
- `TransferFailed`: ERC‑20 transfer/transferFrom failed or returned false or amount mismatch.
- `ValidatorLimitReached`: validator set would exceed `MAX_VALIDATORS_PER_JOB`.
- `InvalidValidatorThresholds`: approval/disapproval thresholds violate limits.
- `ValidatorSetTooLarge`: validator array length exceeds the maximum.
- `IneligibleAgentPayout`: agent has no AGI type payout eligibility.
- `InvalidAgentPayoutSnapshot`: agent payout snapshot is missing or invalid.
- `InsufficientWithdrawableBalance`: attempted withdrawal exceeds `withdrawableAGI()`.
- `InsolventEscrowBalance`: contract ERC‑20 balance is below `lockedEscrow`.

## Events

Indexed parameters are marked **indexed**. Events should be used for off‑chain tracking.

- `JobCreated(uint256 jobId, string jobSpecURI, uint256 payout, uint256 duration, string details)`
- `JobApplied(uint256 jobId, address agent)`
- `JobCompletionRequested(uint256 jobId, address agent, string jobCompletionURI)`
- `JobValidated(uint256 jobId, address validator)`
- `JobDisapproved(uint256 jobId, address validator)`
- `JobCompleted(uint256 jobId, address agent, uint256 reputationPoints)`
- `ReputationUpdated(address user, uint256 newReputation)`
- `JobCancelled(uint256 jobId)`
- `DisputeResolved(uint256 jobId, address resolver, string resolution)`
- `DisputeResolvedWithCode(uint256 jobId, address resolver, uint8 resolutionCode, string reason)`
- `JobDisputed(uint256 jobId, address disputant)`
- `JobExpired(uint256 jobId, address employer, address agent, uint256 payout)`
- `JobFinalized(uint256 jobId, address agent, address employer, bool agentPaid, uint256 payout)`
- `DisputeTimeoutResolved(uint256 jobId, address resolver, bool employerWins)`
- `RootNodeUpdated(bytes32 indexed newRootNode)`
- `MerkleRootUpdated(bytes32 indexed newMerkleRoot)`
- `OwnershipVerified(address claimant, string subdomain)`
- `RecoveryInitiated(string reason)`
- `AGITypeUpdated(address indexed nftAddress, uint256 payoutPercentage)`
- `NFTIssued(uint256 indexed tokenId, address indexed employer, string tokenURI)`
- `NFTListed(uint256 indexed tokenId, address indexed seller, uint256 price)`
- `NFTPurchased(uint256 indexed tokenId, address indexed buyer, uint256 price)`
- `NFTDelisted(uint256 indexed tokenId)`
- `RewardPoolContribution(address indexed contributor, uint256 amount)`
- `CompletionReviewPeriodUpdated(uint256 oldPeriod, uint256 newPeriod)`
- `DisputeReviewPeriodUpdated(uint256 oldPeriod, uint256 newPeriod)`
- `AdditionalAgentPayoutPercentageUpdated(uint256 newPercentage)`
- `AGIWithdrawn(address indexed to, uint256 amount, uint256 remainingWithdrawable)`
- Standard ERC‑721 events:
  - `Transfer(address indexed from, address indexed to, uint256 indexed tokenId)`
  - `Approval(address indexed owner, address indexed approved, uint256 indexed tokenId)`
  - `ApprovalForAll(address indexed owner, address indexed operator, bool approved)`
  - `Paused(address account)` / `Unpaused(address account)`
  - `OwnershipTransferred(address indexed previousOwner, address indexed newOwner)`

> Note: `RootNodeUpdated` and `MerkleRootUpdated` are declared events but are not emitted by the current implementation.

## Public state variables (selected)

All are public and have autogenerated getters.

- `agiToken`: ERC‑20 token used for escrow and payouts.
- `baseIpfsUrl`: base prefix for job NFT token URIs (used when completion URI is not a full URI).
- `MAX_VALIDATORS_PER_JOB`: constant hard cap (50).
- `requiredValidatorApprovals`, `requiredValidatorDisapprovals`: thresholds for completing/disputing a job.
- `validationRewardPercentage`: percent of payout reserved for validators.
- `additionalAgentPayoutPercentage`: stored config value (not used in current payout logic).
- `maxJobPayout`, `jobDurationLimit`: upper bounds for job creation.
- `completionReviewPeriod`, `disputeReviewPeriod`: timeouts for `finalizeJob` and `resolveStaleDispute`.
- `lockedEscrow`: total escrowed ERC‑20 reserved for unsettled jobs.
- `clubRootNode`, `agentRootNode`: ENS root nodes for validators and agents.
- `validatorMerkleRoot`, `agentMerkleRoot`: Merkle roots for allowlists.
- `ens`, `nameWrapper`: ENS registry and NameWrapper addresses.
- `nextJobId`, `nextTokenId`: monotonically increasing IDs for jobs and NFTs.
- `jobs(jobId)`: returns core job fields (excluding mappings and validator array contents).
- `reputation(user)`: on‑chain reputation score (capped by diminishing returns).
- `moderators`, `additionalValidators`, `additionalAgents`, `blacklistedAgents`, `blacklistedValidators` mappings.
- `validatorApprovedJobs(address, index)`: access per‑validator approved job IDs.
- `listings(tokenId)`: marketplace listing info.
- `agiTypes(index)`: AGI type NFT and payout percentage configuration.

## Function access matrix (state‑changing)

| Function | Caller | Preconditions | Effects | Reverts (custom errors / require) |
| --- | --- | --- | --- | --- |
| `pause()` | Owner | — | Pauses contract; emits `Paused`. | Standard `Ownable` check. |
| `unpause()` | Owner | — | Unpauses contract; emits `Unpaused`. | Standard `Ownable` check. |
| `lockConfiguration()` | Owner | Not already locked | Permanently locks critical wiring setters; emits `ConfigurationLocked`. | `ConfigLocked`. |
| `createJob(jobSpecURI,payout,duration,details)` | Employer | Not paused; payout/duration within limits; URI is non‑empty & no whitespace | Escrows `payout`, stores job, emits `JobCreated`. | `InvalidParameters`, `TransferFailed`, `Pausable: paused`. |
| `applyForJob(jobId,subdomain,proof)` | Agent | Not paused; job unassigned; not blacklisted; ownership verified or allowlisted; agent payout eligibility > 0 | Assigns agent, snapshots payout percentage, emits `JobApplied`. | `JobNotFound`, `InvalidState`, `Blacklisted`, `NotAuthorized`, `IneligibleAgentPayout`, `Pausable: paused`. |
| `requestJobCompletion(jobId,jobCompletionURI)` | Assigned agent | Not paused (unless disputed); job active; completion not already requested; valid URI | Stores completion URI and timestamp, emits `JobCompletionRequested`. | `JobNotFound`, `InvalidParameters`, `NotAuthorized`, `InvalidState`, `Pausable: paused` (require). |
| `validateJob(jobId,subdomain,proof)` | Validator | Not paused; job active; completion requested; not blacklisted; ownership verified or allowlisted; no prior vote | Records approval, emits `JobValidated`; may complete job at approval threshold. | `JobNotFound`, `InvalidState`, `Blacklisted`, `NotAuthorized`, `ValidatorLimitReached`, `Pausable: paused`, plus any `_completeJob` errors. |
| `disapproveJob(jobId,subdomain,proof)` | Validator | Not paused; job active; completion requested; not blacklisted; ownership verified or allowlisted; no prior vote | Records disapproval, emits `JobDisapproved`; may open dispute at disapproval threshold. | `JobNotFound`, `InvalidState`, `Blacklisted`, `NotAuthorized`, `ValidatorLimitReached`, `Pausable: paused`. |
| `disputeJob(jobId)` | Employer or Agent | Not paused; completion requested; job not completed/expired; not already disputed | Marks dispute, emits `JobDisputed`. | `JobNotFound`, `InvalidState`, `NotAuthorized`, `Pausable: paused`. |
| `resolveDispute(jobId,resolution)` | Moderator | Disputed and not expired | Resolves dispute for canonical strings `"agent win"` / `"employer win"` or no‑action; emits resolution events. | `NotModerator`, `JobNotFound`, `InvalidState`, `InvalidParameters`, plus `_completeJob` errors on AGENT_WIN. |
| `resolveDisputeWithCode(jobId,resolutionCode,reason)` | Moderator | Disputed and not expired | Resolves based on `DisputeResolutionCode`; emits resolution events. | `NotModerator`, `JobNotFound`, `InvalidState`, `InvalidParameters`, plus `_completeJob` errors on AGENT_WIN. |
| `resolveStaleDispute(jobId,employerWins)` | Owner | Paused; disputed; `disputedAt` set; timeout exceeded | Resolves dispute after timeout; emits recovery + `DisputeTimeoutResolved`. | `JobNotFound`, `InvalidState`. |
| `blacklistAgent(agent,status)` | Owner | — | Updates agent blacklist. | Standard `Ownable` check. |
| `blacklistValidator(validator,status)` | Owner | — | Updates validator blacklist. | Standard `Ownable` check. |
| `delistJob(jobId)` | Owner | Job unassigned and not completed | Returns escrow and deletes job; emits `JobCancelled`. | `JobNotFound`, `InvalidState`. |
| `addModerator(moderator)` | Owner | — | Grants moderator role. | Standard `Ownable` check. |
| `removeModerator(moderator)` | Owner | — | Revokes moderator role. | Standard `Ownable` check. |
| `updateAGITokenAddress(newToken)` | Owner | Config unlocked; no jobs or escrow | Changes ERC‑20 used for escrow/payouts. | `ConfigLocked`, `InvalidState`, `InvalidParameters`. |
| `updateENSRegistry(newEns)` | Owner | Config unlocked; no jobs or escrow | Updates ENS registry reference. | `ConfigLocked`, `InvalidState`, `InvalidParameters`. |
| `updateNameWrapper(newNameWrapper)` | Owner | Config unlocked; no jobs or escrow | Updates NameWrapper reference. | `ConfigLocked`, `InvalidState`, `InvalidParameters`. |
| `updateRootNodes(club,agent,alphaClub,alphaAgent)` | Owner | Config unlocked; no jobs or escrow | Updates ENS root nodes. | `ConfigLocked`, `InvalidState`. |
| `setValidatorMerkleRoot(root)` | Owner | — | Updates validator Merkle allowlist root. | Standard `Ownable` check. |
| `setAgentMerkleRoot(root)` | Owner | — | Updates agent Merkle allowlist root. | Standard `Ownable` check. |
| `setBaseIpfsUrl(url)` | Owner | — | Updates base URI prefix. | Standard `Ownable` check. |
| `setRequiredValidatorApprovals(approvals)` | Owner | Thresholds valid | Updates approval threshold. | `InvalidValidatorThresholds`. |
| `setRequiredValidatorDisapprovals(disapprovals)` | Owner | Thresholds valid | Updates disapproval threshold. | `InvalidValidatorThresholds`. |
| `setPremiumReputationThreshold(threshold)` | Owner | — | Updates premium feature threshold. | Standard `Ownable` check. |
| `setMaxJobPayout(maxPayout)` | Owner | — | Updates maximum job payout. | Standard `Ownable` check. |
| `setJobDurationLimit(limit)` | Owner | — | Updates job duration cap. | Standard `Ownable` check. |
| `setCompletionReviewPeriod(period)` | Owner | 1…365 days | Updates completion review period; emits `CompletionReviewPeriodUpdated`. | `InvalidParameters`. |
| `setDisputeReviewPeriod(period)` | Owner | 1…365 days | Updates dispute review period; emits `DisputeReviewPeriodUpdated`. | `InvalidParameters`. |
| `setAdditionalAgentPayoutPercentage(percentage)` | Owner | 1…100 and compatible with validator reward | Stores config value; emits `AdditionalAgentPayoutPercentageUpdated`. | `InvalidParameters`. |
| `updateTermsAndConditionsIpfsHash(hash)` | Owner | — | Updates metadata field. | Standard `Ownable` check. |
| `updateContactEmail(email)` | Owner | — | Updates metadata field. | Standard `Ownable` check. |
| `updateAdditionalText1(text)` | Owner | — | Updates metadata field. | Standard `Ownable` check. |
| `updateAdditionalText2(text)` | Owner | — | Updates metadata field. | Standard `Ownable` check. |
| `updateAdditionalText3(text)` | Owner | — | Updates metadata field. | Standard `Ownable` check. |
| `setValidationRewardPercentage(percentage)` | Owner | 1…100 and compatible with AGI type max | Updates validator reward percentage. | `InvalidParameters`. |
| `cancelJob(jobId)` | Employer | Caller is employer; job unassigned; not completed | Refunds escrow, deletes job; emits `JobCancelled`. | `JobNotFound`, `NotAuthorized`, `InvalidState`. |
| `expireJob(jobId)` | Anyone | Job assigned; duration elapsed; no completion request; not disputed/completed/expired | Refunds escrow to employer; emits `JobExpired`. | `JobNotFound`, `InvalidState`. |
| `finalizeJob(jobId)` | Anyone | Completion requested; review period elapsed; not disputed/completed/expired | Finalizes using validator counts; emits `JobFinalized`. | `JobNotFound`, `InvalidState`, plus `_completeJob` errors if agent wins. |
| `listNFT(tokenId,price)` | NFT owner | Not paused; price > 0 | Creates listing; emits `NFTListed`. | `NotAuthorized`, `InvalidParameters`, `Pausable: paused`. |
| `purchaseNFT(tokenId)` | Buyer | Not paused; listing active; buyer ≠ seller; seller still owns token | Transfers ERC‑20 and NFT; emits `NFTPurchased`. | `InvalidState`, `NotAuthorized`, `InvalidParameters`, `TransferFailed`, `Pausable: paused`, ERC‑721 transfer reverts. |
| `delistNFT(tokenId)` | Seller | Not paused; listing active | Deactivates listing; emits `NFTDelisted`. | `NotAuthorized`, `Pausable: paused`. |
| `addAdditionalValidator(validator)` | Owner | — | Adds explicit validator allowlist. | Standard `Ownable` check. |
| `removeAdditionalValidator(validator)` | Owner | — | Removes explicit validator allowlist. | Standard `Ownable` check. |
| `addAdditionalAgent(agent)` | Owner | — | Adds explicit agent allowlist. | Standard `Ownable` check. |
| `removeAdditionalAgent(agent)` | Owner | — | Removes explicit agent allowlist. | Standard `Ownable` check. |
| `withdrawAGI(amount)` | Owner | Paused; amount > 0; ≤ withdrawable | Transfers surplus ERC‑20; emits `AGIWithdrawn`. | `InvalidParameters`, `InsolventEscrowBalance`, `InsufficientWithdrawableBalance`, `TransferFailed`. |
| `contributeToRewardPool(amount)` | Anyone | Not paused; amount > 0 | Transfers ERC‑20 into contract; emits `RewardPoolContribution`. | `InvalidParameters`, `TransferFailed`, `Pausable: paused`. |
| `addAGIType(nftAddress,payoutPercentage)` | Owner | Non‑zero address; percentage 1…100; compatible with validator reward | Adds/updates AGI type; emits `AGITypeUpdated`. | `InvalidParameters`. |
| `approve(to,tokenId)` | Token owner/approved | ERC‑721 standard preconditions | Approves transfer of a token; emits `Approval`. | ERC‑721 standard reverts (owner/approval checks). |
| `setApprovalForAll(operator,approved)` | Token owner | ERC‑721 standard preconditions | Approves operator; emits `ApprovalForAll`. | ERC‑721 standard reverts (operator cannot be caller). |
| `transferFrom(from,to,tokenId)` | Owner/approved | ERC‑721 standard preconditions | Transfers token; emits `Transfer`. | ERC‑721 standard reverts (ownership/approval). |
| `safeTransferFrom(from,to,tokenId)` | Owner/approved | ERC‑721 standard preconditions + receiver check | Safe transfer; emits `Transfer`. | ERC‑721 standard reverts (ownership/approval/receiver). |
| `safeTransferFrom(from,to,tokenId,data)` | Owner/approved | ERC‑721 standard preconditions + receiver check | Safe transfer; emits `Transfer`. | ERC‑721 standard reverts (ownership/approval/receiver). |
| `transferOwnership(newOwner)` | Owner | newOwner != 0 | Transfers ownership; emits `OwnershipTransferred`. | Standard `Ownable` check. |
| `renounceOwnership()` | Owner | — | Renounces ownership; emits `OwnershipTransferred`. | Standard `Ownable` check. |

## View functions (all callable by anyone)

| Function | Returns | Notes | Reverts |
| --- | --- | --- | --- |
| `MAX_VALIDATORS_PER_JOB()` | `uint256` | Hard cap for validators. | — |
| `additionalAgentPayoutPercentage()` | `uint256` | Stored config value. | — |
| `additionalAgents(address)` | `bool` | Explicit agent allowlist. | — |
| `additionalValidators(address)` | `bool` | Explicit validator allowlist. | — |
| `agentMerkleRoot()` | `bytes32` | Merkle root for agents. | — |
| `agentRootNode()` | `bytes32` | ENS root node for agents. | — |
| `agiToken()` | `address` | ERC‑20 token address. | — |
| `agiTypes(index)` | `(address,uint256)` | AGI type NFT address + payout percentage. | — |
| `balanceOf(owner)` | `uint256` | ERC‑721 balance. | ERC‑721 standard reverts if `owner` is zero. |
| `blacklistedAgents(address)` | `bool` | Agent blacklist. | — |
| `blacklistedValidators(address)` | `bool` | Validator blacklist. | — |
| `clubRootNode()` | `bytes32` | ENS root node for validators. | — |
| `completionReviewPeriod()` | `uint256` | Completion review period. | — |
| `contactEmail()` | `string` | Informational metadata. | — |
| `disputeReviewPeriod()` | `uint256` | Dispute review period. | — |
| `ens()` | `address` | ENS registry address. | — |
| `getApproved(tokenId)` | `address` | ERC‑721 approved address. | ERC‑721 standard reverts if token does not exist. |
| `getJobStatus(jobId)` | `(bool,bool,string)` | Completed flag, completionRequested flag, and status URI. | — |
| `getJobAgentPayoutPct(jobId)` | `uint256` | Snapshotted agent payout percentage. | `JobNotFound`. |
| `isApprovedForAll(owner,operator)` | `bool` | ERC‑721 operator approval. | — |
| `jobDurationLimit()` | `uint256` | Job duration cap. | — |
| `jobStatus(jobId)` | `JobStatus` | Canonical status enum (may be Expired by time). | `JobNotFound`. |
| `jobs(jobId)` | tuple | Core job fields (no mappings/arrays). | — |
| `listings(tokenId)` | `(uint256,address,uint256,bool)` | Listing info. | — |
| `lockedEscrow()` | `uint256` | Total escrow reserved for unsettled jobs. | — |
| `maxJobPayout()` | `uint256` | Maximum allowed payout. | — |
| `moderators(address)` | `bool` | Moderator allowlist. | — |
| `name()` | `string` | ERC‑721 name. | — |
| `nameWrapper()` | `address` | ENS NameWrapper address. | — |
| `nextJobId()` | `uint256` | Next job ID. | — |
| `nextTokenId()` | `uint256` | Next NFT ID. | — |
| `owner()` | `address` | Contract owner. | — |
| `ownerOf(tokenId)` | `address` | NFT owner. | ERC‑721 standard reverts if token does not exist. |
| `paused()` | `bool` | Pausable state. | — |
| `premiumReputationThreshold()` | `uint256` | Reputation threshold for premium access. | — |
| `reputation(address)` | `uint256` | Reputation score. | — |
| `requiredValidatorApprovals()` | `uint256` | Approval threshold. | — |
| `requiredValidatorDisapprovals()` | `uint256` | Disapproval threshold. | — |
| `supportsInterface(interfaceId)` | `bool` | ERC‑165 support. | — |
| `symbol()` | `string` | ERC‑721 symbol. | — |
| `termsAndConditionsIpfsHash()` | `string` | Informational metadata. | — |
| `tokenURI(tokenId)` | `string` | Stored token URI for job NFT. | ERC‑721 standard reverts if token does not exist. |
| `validationRewardPercentage()` | `uint256` | Validator reward percentage. | — |
| `validatorApprovedJobs(address,index)` | `uint256` | Job IDs approved/disapproved by validator. | — |
| `validatorMerkleRoot()` | `bytes32` | Merkle root for validators. | — |
| `withdrawableAGI()` | `uint256` | `balanceOf(this) - lockedEscrow` (reverts if insolvent). | `InsolventEscrowBalance`. |
| `canAccessPremiumFeature(user)` | `bool` | True if `reputation >= premiumReputationThreshold`. | — |
| `getHighestPayoutPercentage(agent)` | `uint256` | Max AGI type percentage among NFTs held. | — |
| `additionalText1()` / `additionalText2()` / `additionalText3()` | `string` | Informational metadata. | — |

## Detailed behavior notes (selected)

### Eligibility verification
- The Merkle leaf is `keccak256(abi.encodePacked(claimant))` and is checked against either `agentMerkleRoot` or `validatorMerkleRoot` depending on which root node is passed to `_verifyOwnership`.
- ENS subnode is `keccak256(rootNode, keccak256(subdomain))`.
- Ownership is verified by NameWrapper `ownerOf(uint256(subnode))` and Resolver `addr(subnode)`. Failures emit `RecoveryInitiated`.

### Job completion & payout
- `agentPayoutPct` is snapshotted at assignment; if it is zero at completion, the job cannot be completed (`InvalidAgentPayoutSnapshot`).
- If no validators participate, the validator payout is zero and the entire payout is split between agent and employer/escrow rules.
- Completion requires a non‑empty, whitespace‑free completion URI.

### Marketplace
- Listings are purely internal and require the seller still owns the token at purchase time.
- Purchases transfer ERC‑20 **before** transferring the NFT.
